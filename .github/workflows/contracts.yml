name: Contract Tests
on: [push, pull_request]

concurrency:
  cancel-in-progress: true
  group: ${{ github.ref_name }}

jobs:
  contracts-lint:
    name: "Linter"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - run: yarn config set cacheFolder /runner/_work/.yarn-cache

    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "::set-output name=dir::$(yarn config get cacheFolder)"

    - uses: actions/cache@v3
      id: yarn-cache
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: 1-${{ runner.os }}-yarn-${{ hashFiles('contracts/yarn.lock') }}-contracts
        restore-keys: |
          1-${{ runner.os }}-yarn-contracts

    - run: yarn install
      working-directory: ./contracts

    - run: yarn run lint
      working-directory: ./contracts

    - run: yarn prettier:check
      working-directory: ./contracts

  contracts-test:
    name: "Unit Tests"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - run: yarn config set cacheFolder /runner/_work/.yarn-cache

    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "::set-output name=dir::$(yarn config get cacheFolder)"

    - uses: actions/cache@v3
      id: yarn-cache
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: 1-${{ runner.os }}-yarn-${{ hashFiles('contracts/yarn.lock') }}-contracts
        restore-keys: |
          1-${{ runner.os }}-yarn-contracts

    - run: yarn install
      working-directory: ./contracts


    - run: yarn run test
      working-directory: ./contracts

  contracts-forktest:
    name: "Fork Tests"
    runs-on: ubuntu-latest
    env:
      HARDHAT_CACHE_DIR: /runner/_work/hardhat-cache
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js
      uses: actions/setup-node@v2
      with:
        node-version: "14.x"

    - run: yarn config set cacheFolder /runner/_work/.yarn-cache

    - name: Get yarn cache directory path
      id: yarn-cache-dir-path
      run: echo "::set-output name=dir::$(yarn config get cacheFolder)"

    - uses: actions/cache@v3
      id: yarn-cache
      with:
        path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
        key: 1-${{ runner.os }}-yarn-${{ hashFiles('contracts/yarn.lock') }}-contracts
        restore-keys: |
          1-${{ runner.os }}-yarn-contracts

    - uses: actions/cache@v3
      id: hardhat-cache
      with:
        path: /runner/_work/hardhat-cache
        key: 1-${{ runner.os }}-hardhat-${{ hashFiles('/runner/_work/hardhat-cache/*.json') }}
        restore-keys: |
          1-${{ runner.os }}-hardhat-cache

    - run: yarn install
      working-directory: ./contracts


    - run: yarn run test:fork
      working-directory: ./contracts
