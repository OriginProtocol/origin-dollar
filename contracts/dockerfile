FROM node:20-bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    git \
    openssh-client \
  && rm -rf /var/lib/apt/lists/*

# Preload GitHub host key for SSH-based dependencies.
RUN mkdir -p /root/.ssh \
  && ssh-keyscan -t rsa github.com >> /root/.ssh/known_hosts

RUN git config --global url."https://github.com/".insteadOf "git@github.com:"

ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.2.39/supercronic-linux-amd64 \
  SUPERCRONIC_SHA1SUM=c98bbf82c5f648aaac8708c182cc83046fe48423 \
  SUPERCRONIC=supercronic-linux-amd64

RUN curl -fsSLO "$SUPERCRONIC_URL" \
  && echo "${SUPERCRONIC_SHA1SUM}  ${SUPERCRONIC}" | sha1sum -c - \
  && chmod +x "$SUPERCRONIC" \
  && mv "$SUPERCRONIC" "/usr/local/bin/${SUPERCRONIC}" \
  && ln -s "/usr/local/bin/${SUPERCRONIC}" /usr/local/bin/supercronic

WORKDIR /app

# Enable pnpm via corepack and install dependencies first for better caching.
COPY pnpm-lock.yaml package.json ./
RUN corepack enable \
  && pnpm install --frozen-lockfile

# Copy the rest of the contracts workspace.
COPY . .

ENV PROVIDER_URL="" \
  BEACON_PROVIDER_URL="" \
  DEFENDER_API_KEY="" \
  DEFENDER_API_SECRET="" \
  HARDHAT_NETWORK=mainnet

# Scripts executed by cron every hour (snapBalances runs five minutes earlier).
RUN cat <<'EOF' > /usr/local/bin/run-snap-balances.sh
#!/usr/bin/env bash
set -euo pipefail
cd /app
export PROVIDER_URL BEACON_PROVIDER_URL DEFENDER_API_KEY DEFENDER_API_SECRET HARDHAT_NETWORK
pnpm hardhat snapBalances --network "${HARDHAT_NETWORK:-mainnet}"
EOF
RUN cat <<'EOF' > /usr/local/bin/run-hourly-tasks.sh
#!/usr/bin/env bash
set -euo pipefail
cd /app
export PROVIDER_URL BEACON_PROVIDER_URL DEFENDER_API_KEY DEFENDER_API_SECRET HARDHAT_NETWORK
pnpm hardhat
pnpm hardhat verifyBalances --network "${HARDHAT_NETWORK:-mainnet}"
pnpm hardhat verifyDeposits --network "${HARDHAT_NETWORK:-mainnet}"
pnpm hardhat autoValidatorDeposits --network "${HARDHAT_NETWORK:-mainnet}"
pnpm hardhat autoValidatorWithdrawals --network "${HARDHAT_NETWORK:-mainnet}"
EOF
RUN chmod +x /usr/local/bin/run-snap-balances.sh /usr/local/bin/run-hourly-tasks.sh

# Cron configuration for supercronic.
RUN printf '55 * * * * /usr/local/bin/run-snap-balances.sh\n0 * * * * /usr/local/bin/run-hourly-tasks.sh\n' > /etc/cronjob

ENTRYPOINT ["supercronic", "/etc/cronjob"]
