@startuml

title "OETH Flow of Value"

actor "User" as user
actor "Harvester" as harvUser
actor "Trustee" as trust <<Origin>> #DeepSkyBlue
participant "OETH\nVault" as vault <<Origin>> #DeepSkyBlue
participant "Harvester" as harv <<Origin>> #DeepSkyBlue
participant "Dripper" as drip <<Origin>> #DeepSkyBlue

participant "FRAX\nStrategy" as frxStrat <<Origin>> #DeepSkyBlue
participant "Staked\nFRAX ETH" as sfrxETH <<FRAX>><<sfrxETH>>

participant "Curve AMO\nStrategy" as crvStrat <<Origin>> #DeepSkyBlue

participant "Wrapped ETH" as weth <<DappHub>><<WETH>>
participant "OETH\nMetapool" as oethCrv <<Curve>>
participant "OETH\nPool" as oethCvx <<Convex>>
participant "Rewards\nPool" as cvxRewards <<Convex>>
participant "Locked CVX" as icvx <<Convex>>

participant "Uniswap V2" as uni <<Uniswap>>

' Mint
group User mint [< 10 OETH]
vault o-> trust : OETH
note left : 20% performance\nfee from rebase

user -> vault : frxETH, stETH, rETH or WETH
note left: Only to vault,\nnot strategy as <10 ETH
vault o-> user : OETH
note left : mint OETH to\nUSD value of deposit
end

' Allocate
group Vault allocate [anyone can call]

group FRAX Strategy [unallocated frxETH in vault]
vault -> frxStrat : frxETH
frxStrat -> sfrxETH : frxETH
note left : deposit frxETH
sfrxETH o-> frxStrat : sfrxETH
note left : get sfrxETH shares
end

group Curve AMO Strategy [unallocated WETH in vault]
vault -> crvStrat : WETH
crvStrat -x weth : WETH
weth -> crvStrat : ETH


crvStrat o-> crvStrat : OETH
note left : mint OETH where WETH <= OETH <= 2x WETH
crvStrat -> oethCrv : ETH, OETH
note left : add liquidity to the Metapool
oethCrv o-> crvStrat : OETHCRV-f
note left: strategy gets Metapool LP tokens

crvStrat -> oethCvx : OETHCRV-f
note left : deposit Metapool LP to Convex
oethCvx o-> cvxRewards : cvxOETHCRV-f
note left : stake Convex LP tokens
end
end

' Redeem
group User redeem OETH
vault o-> trust : OETH
note left : 20% performance\nfee from rebase

user -x vault : OETH
note left : burn User's OETH

note over vault : 0.5% fee applied to redeemed assets.\nThis adds to the yield in the next rebase.

' FRAX Strategy
group FRAX Strategy [not enough frxETH in vault]
frxStrat -x sfrxETH : sfrxETH
note left : redeem sfrxETH shares
' sfrxETH -> frxStrat : frxETH
sfrxETH -> user : frxETH
note left : transfer directly to user
end

' Curve AMO Strategy
group Curve AMO Strategy [not enough WETH in vault]
cvxRewards -x oethCvx : cvxOETHCRV-f
note left : unstake and burn Convex LP tokens
oethCvx -> crvStrat : OETHCRV-f
note left : withdraw Metapool LP tokens

crvStrat -x oethCrv : OETHCRV-f
note left : burn Metapool LP tokens
oethCrv -> crvStrat : ETH, OETH
note left : remove liquidity to the Metapool

crvStrat -x crvStrat : OETH
note left : burn OETH withdrawn from Curve

crvStrat -> weth : ETH
note left : deposit ETH into Wrapped ETH
weth o-> user : WETH
note left : transfer directly to user
end

note over vault : no strategy so comes from vault
vault -> user : stETH
vault -> user : rETH
end

' Harvest and Swap
group Harvest and Swap [can be called by anyone]

cvxRewards -> harv : CVX & CRV
note left : collect Convex rewards

harv -> uni : CVX
note left : swap CVX for ETH
uni -> harv : WETH
harv -> drip : WETH
note left : 99% of WETH to Dripper
harv -> harvUser : WETH
note left : 1% of WETH\nto Harvest caller

harv -> uni : CRV
note left : swap CRV for ETH
uni -> harv : WETH
harv -> drip : WETH
note left : 99% of WETH to Dripper
harv -> harvUser : WETH
note left : 1% of WETH\nto Harvest caller
end

' Collect and Rebase
group Collect and Rebase [can be called by anyone]

drip -> vault : WETH
note left : stream WETH to vault

vault o-> trust : OETH
note left : 20% performance\nfee from rebase
end

group Trustee buys and locks CVX for voting power

trust -> uni : OETH
note left : swap for CVX using Uniswap
uni -> trust : CVX

trust -> icvx : CVX
note left : lock CVX for delegated voting power
icvx -> trust : vlCVX

end

@enduml
